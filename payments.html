<!DOCTYPE html>
<html class="no-js" lang="zxx">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kalenjin Vibes | Payments</title>
  <meta name="author" content="Kalenjin Vibes">
  <meta name="description" content="Secure payment processing for events, talent bookings, and merchandise.">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#BA0909',
            secondary: '#222',
            light: '#f8f9fa',
            dark: '#1a1a1a'
          },
          fontFamily: {
            'jost': ['Jost', 'sans-serif']
          }
        }
      }
    }
  </script>
  
  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z93DQW5D1S"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Z93DQW5D1S');
  </script>
  
  <style>
    /* Mobile Menu Styles */
    .mobile-menu-modal {
        display: none;
    }
    
    .mobile-menu-modal.active {
        display: block;
    }
    
    .mobile-menu-content {
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }
    
    .mobile-menu-modal.active .mobile-menu-content {
        transform: translateX(0);
    }
    
    .mobile-menu-nav a:hover {
        background: #f9f9f9;
        color: #BA0909;
    }
    
    /* WhatsApp Button */
    .whatsapp-button-payments {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #25D366, #128C7E);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        text-decoration: none;
    }
    
    .whatsapp-button-payments:hover {
        transform: scale(1.1) translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    
    .whatsapp-button-payments img {
        width: 35px;
        height: 35px;
        filter: brightness(0) invert(1);
    }
    
    /* Custom copy button styles */
    .copy-btn-inline {
        background: #28a745;
        border: none;
        color: white;
        padding: 6px 14px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        margin-left: 10px;
        vertical-align: middle;
    }
    
    .copy-btn-inline:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        background: #218838;
    }
    
    /* Transaction input */
    #transaction_reference {
        font-family: 'Courier New', monospace;
        letter-spacing: 1.5px;
        text-transform: uppercase;
    }
  </style>
</head>
<body class="font-jost bg-gray-50">

  <!-- Mobile Menu Modal -->
  <div id="mobileMenuModal" class="mobile-menu-modal fixed inset-0 z-50 bg-black bg-opacity-50">
    <div class="mobile-menu-content absolute top-0 right-0 w-80 h-full bg-white overflow-y-auto">
      <div class="mobile-menu-header flex justify-between items-center p-4 bg-primary text-white">
        <h3 class="text-lg font-bold">Menu</h3>
        <button onclick="closeMobileMenu()" class="mobile-menu-close bg-none border-none text-white text-xl cursor-pointer">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <nav class="mobile-menu-nav py-4">
        <ul>
          <li class="border-b border-gray-100">
            <a href="index.html" class="block px-4 py-3 text-gray-800 hover:text-primary">
              <i class="fas fa-home w-6 text-center mr-3"></i> Home
            </a>
          </li>
          <li class="border-b border-gray-100">
            <a href="eventslist.html" class="block px-4 py-3 text-gray-800 hover:text-primary">
              <i class="fas fa-calendar-alt w-6 text-center mr-3"></i> Events
            </a>
          </li>
          <li class="border-b border-gray-100">
            <a href="talentlist.html" class="block px-4 py-3 text-gray-800 hover:text-primary">
              <i class="fas fa-users w-6 text-center mr-3"></i> Talent
            </a>
          </li>
          <li class="border-b border-gray-100">
            <a href="shop.html" class="block px-4 py-3 text-gray-800 hover:text-primary">
              <i class="fas fa-shopping-bag w-6 text-center mr-3"></i> Shop
            </a>
          </li>
          <li class="border-b border-gray-100">
            <a href="payments.html" class="block px-4 py-3 text-gray-800 hover:text-primary">
              <i class="fas fa-credit-card w-6 text-center mr-3"></i> Payments
            </a>
          </li>
          <li class="border-b border-gray-100">
            <a href="about.html" class="block px-4 py-3 text-gray-800 hover:text-primary">
              <i class="fas fa-info-circle w-6 text-center mr-3"></i> About
            </a>
          </li>
          <li class="border-b border-gray-100">
            <a href="contact.html" class="block px-4 py-3 text-gray-800 hover:text-primary">
              <i class="fas fa-envelope w-6 text-center mr-3"></i> Contact
            </a>
          </li>
        </ul>
      </nav>
      <div class="mobile-menu-footer p-4 border-t border-gray-200 text-center">
        <div class="social-icons flex justify-center gap-3 mb-3">
          <a href="#" class="social-icon w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-800 hover:bg-primary hover:text-white">
            <i class="fab fa-facebook-f"></i>
          </a>
          <a href="#" class="social-icon w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-800 hover:bg-primary hover:text-white">
            <i class="fab fa-twitter"></i>
          </a>
          <a href="#" class="social-icon w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-800 hover:bg-primary hover:text-white">
            <i class="fab fa-instagram"></i>
          </a>
        </div>
        <p class="copyright text-xs text-gray-500">¬© <span class="current-year"></span> Kalenjin Vibes</p>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div id="header-container"></div>

  <!-- Breadcrumb -->
  <div class="relative bg-cover bg-center py-16" style="background-image: linear-gradient(135deg, rgba(0, 0, 0, 0.7), rgba(186, 9, 9, 0.8)), url('assets/img/breadcumb/breadcumb-bg.jpg');">
    <div class="container mx-auto px-4">
      <div class="relative z-10 text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">Make Payment</h1>
        <div class="flex justify-center">
          <ul class="flex list-none p-0 m-0 text-sm md:text-base">
            <li class="mx-2">
              <a href="index.html" class="text-white hover:text-gray-200 transition-colors">Home</a>
            </li>
            <li class="mx-2 text-gray-300">/</li>
            <li class="mx-2 text-white font-medium">Payments</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Form Section -->
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- Order Summary -->
      <div id="orderSummary" class="p-6 border-b border-gray-200" style="display: none;">
        <h5 class="text-xl font-bold text-gray-800 mb-4">Order Summary</h5>
        <div id="order-items" class="mb-4"></div>
        <div class="order-total pt-4 border-t border-gray-200">
          <div class="flex justify-between items-center">
            <span class="text-lg font-medium">Total:</span>
            <span id="total-amount-display" class="text-2xl font-bold text-primary">Ksh 0</span>
          </div>
        </div>
      </div>
      
      <!-- Booking Summary -->
      <div id="bookingSummary" class="p-6 border-b border-gray-200" style="display: none;">
        <h5 class="text-xl font-bold text-gray-800 mb-4">Booking Summary</h5>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p class="mb-2"><strong class="text-gray-700">Talent:</strong> <span id="summaryTalentName" class="text-gray-900"></span></p>
          <p class="mb-2"><strong class="text-gray-700">Event:</strong> <span id="summaryEventName" class="text-gray-900">Kalenjin Vibes Night</span></p>
          <p class="mb-0"><strong class="text-gray-700">Amount:</strong> <span id="summaryAmount" class="text-primary font-bold"></span></p>
        </div>
      </div>

      <!-- Payment Form -->
      <form id="payment-form" class="p-6">
        <input type="hidden" id="bookingType" name="booking_type" value="">
        <input type="hidden" id="bookingTalentId" name="talent_id" value="">
        <input type="hidden" id="bookingTalentName" name="talent_name" value="">
        <input type="hidden" id="bookingEventName" name="event_name" value="Kalenjin Vibes Night">
        <input type="hidden" id="bookingLocation" name="location" value="">
        <input type="hidden" id="bookingEventDate" name="event_date" value="">
        <input type="hidden" id="bookingAmount" name="amount" value="">
        <input type="hidden" id="bookingNotes" name="notes" value="">
        
        <!-- Contact Information -->
        <div class="mb-8">
          <h5 class="text-xl font-bold text-gray-800 mb-6">Contact Information</h5>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="full_name" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-user text-primary mr-2"></i> Full Name <span class="text-red-500">*</span>
              </label>
              <input class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                     id="full_name" name="full_name" type="text" placeholder="Enter your full name" required>
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-envelope text-primary mr-2"></i> Email <span class="text-red-500">*</span>
              </label>
              <input class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                     id="email" name="email" type="email" placeholder="your@email.com" required>
            </div>
            <div>
              <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-phone text-primary mr-2"></i> Phone <span class="text-red-500">*</span>
              </label>
              <input class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                     id="phone_number" name="phone_number" type="text" placeholder="07XX XXX XXX" required>
            </div>
          </div>
        </div>

        <!-- Payment Method Selection -->
        <div class="mb-8">
          <label for="payment_method" class="block text-center text-lg font-medium text-gray-700 mb-4">
            <i class="fas fa-credit-card text-primary mr-2"></i> Select Payment Method
          </label>
          <select class="w-full max-w-xs mx-auto px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                  id="payment_method" name="payment_method" required>
            <option value="">Choose method...</option>
            <option value="mpesa">üì± M-Pesa Till</option>
            <option value="paybill">üè¢ Paybill</option>
          </select>
        </div>

        <!-- M-Pesa Instructions -->
        <div id="mpesa-details" class="mb-6" style="display: none;">
          <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
            <div class="text-center mb-6">
              <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/M-PESA_LOGO-01.svg/2560px-M-PESA_LOGO-01.svg.png" 
                   class="max-w-[150px] mx-auto mb-4" alt="M-Pesa">
              <h4 class="text-xl font-bold text-gray-800"><u>LIPA NA MPESA</u></h4>
            </div>
            <ul class="space-y-3">
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">1</span>
                <span>Go to M-PESA on your phone</span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">2</span>
                <span>Select <strong>Lipa Na M-PESA</strong></span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">3</span>
                <span>Select <strong>Buy Goods and Services</strong></span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">4</span>
                <span>Enter Till: <strong class="text-green-600 ml-2">3049015</strong>
                  <button type="button" class="copy-btn-inline" onclick="copyToClipboard('3049015', this)">
                    <i class="fas fa-copy"></i> Copy
                  </button>
                </span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">5</span>
                <span>Enter Amount: <strong class="text-green-600 ml-2" id="mpesaAmount">Ksh 0</strong></span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">6</span>
                <span>Enter your M-PESA PIN and confirm</span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">7</span>
                <span>After payment, enter Transaction Code below</span>
              </li>
            </ul>
            <p class="text-center text-sm text-gray-600 mt-4">
              <i class="fas fa-info-circle text-primary mr-1"></i> Copy Till Number above
            </p>
          </div>
        </div>

        <!-- Paybill Instructions -->
        <div id="paybill-details" class="mb-6" style="display: none;">
          <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
            <div class="text-center mb-6">
              <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/M-PESA_LOGO-01.svg/2560px-M-PESA_LOGO-01.svg.png" 
                   class="max-w-[150px] mx-auto mb-4" alt="M-Pesa">
              <h4 class="text-xl font-bold text-gray-800"><u>LIPA NA MPESA - PAYBILL</u></h4>
            </div>
            <ul class="space-y-3">
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">1</span>
                <span>Go to M-PESA on your phone</span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">2</span>
                <span>Select <strong>Lipa Na M-PESA</strong></span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">3</span>
                <span>Select <strong>Pay Bill</strong></span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">4</span>
                <span>Enter Business No: <strong class="text-green-600 ml-2">542542</strong>
                  <button type="button" class="copy-btn-inline" onclick="copyToClipboard('542542', this)">
                    <i class="fas fa-copy"></i> Copy
                  </button>
                </span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">5</span>
                <span>Enter Account No: <strong class="text-green-600 ml-2">79233</strong>
                  <button type="button" class="copy-btn-inline" onclick="copyToClipboard('79233', this)">
                    <i class="fas fa-copy"></i> Copy
                  </button>
                </span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">6</span>
                <span>Enter Amount: <strong class="text-green-600 ml-2" id="paybillAmount">Ksh 0</strong></span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">7</span>
                <span>Enter your M-PESA PIN and confirm</span>
              </li>
              <li class="flex items-start">
                <span class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-3 mt-0.5">8</span>
                <span>After payment, enter Transaction Code below</span>
              </li>
            </ul>
            <p class="text-center text-sm text-gray-600 mt-4">
              <i class="fas fa-info-circle text-primary mr-1"></i> Copy numbers above
            </p>
          </div>
        </div>

        <!-- Transaction Reference -->
        <div class="mb-8" id="transaction-reference-group" style="display: none;">
          <label for="transaction_reference" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-receipt text-primary mr-2"></i> Transaction Code <span class="text-red-500">*</span>
          </label>
          <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                 id="transaction_reference" name="transaction_reference" placeholder="Enter M-Pesa code (e.g., SH12ABC34D)" required>
          <small class="block text-sm text-gray-500 mt-2">
            <i class="fas fa-info-circle text-primary mr-1"></i> Paste the full M-Pesa message or just the code
          </small>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300 flex items-center justify-center">
            <i class="fas fa-check-circle mr-2"></i> Complete Purchase
          </button>
          <button type="button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300 flex items-center justify-center" id="cancel-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-times mr-2"></i> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <div id="footer-container"></div>

  <!-- Scroll To Top -->
  <a href="#" class="scrollToTop fixed bottom-8 right-8 bg-primary text-white p-3 rounded-full shadow-lg hover:bg-red-800 transition-colors duration-300 z-50 hidden">
    <i class="fas fa-arrow-up"></i>
  </a>
  
  <!-- WhatsApp Button -->
  <a href="https://wa.me/+254797265275" class="whatsapp-button-payments" target="_blank" title="Chat with us on WhatsApp">
    <img src="assets/img/WhatsApp.svg" alt="WhatsApp">
  </a>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Global Mobile Menu Functions -->
  <script>
    window.openMobileMenu = function() {
      const modal = document.getElementById('mobileMenuModal');
      if (modal) {
        modal.classList.add('active');
        document.body.classList.add('overflow-hidden');
      }
    };

    window.closeMobileMenu = function() {
      const modal = document.getElementById('mobileMenuModal');
      if (modal) {
        modal.classList.remove('active');
        document.body.classList.remove('overflow-hidden');
      }
    };

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        window.closeMobileMenu();
      }
    });
  </script>

  <!-- Load Header and Footer -->
  <script>
    fetch('partials/header.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('header-container').innerHTML = data;
        setTimeout(function() {
          const menuToggle = document.querySelector('.vs-menu-toggle');
          if (menuToggle) {
            menuToggle.addEventListener('click', function() {
              window.openMobileMenu();
            });
          }
          const menuLinks = document.querySelectorAll('.mobile-menu-nav a');
          menuLinks.forEach(link => {
            link.addEventListener('click', function() {
              setTimeout(window.closeMobileMenu, 200);
            });
          });
        }, 100);
      })
      .catch(error => console.error('Error loading header:', error));
      
    fetch('partials/footer.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('footer-container').innerHTML = data;
        const yearElements = document.querySelectorAll('.current-year');
        yearElements.forEach(element => {
          element.textContent = new Date().getFullYear();
        });
      })
      .catch(error => console.error('Error loading footer:', error));
  </script>
  
  <!-- Scroll to Top Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const scrollToTopBtn = document.querySelector('.scrollToTop');
      
      window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
          scrollToTopBtn.classList.remove('hidden');
        } else {
          scrollToTopBtn.classList.add('hidden');
        }
      });
      
      scrollToTopBtn.addEventListener('click', function(e) {
        e.preventDefault();
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    });
  </script>

  <!-- UPDATED Payment JavaScript with FIXED Validation -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyARficcDI3R1ELfjkQxL-kkFQr-tzOgzgo",
        authDomain: "k-vibez.firebaseapp.com",
        projectId: "k-vibez",
        storageBucket: "k-vibez.firebasestorage.app",
        messagingSenderId: "1060235903242",
        appId: "1:1060235903242:web:4649b48406879fb7fcfaf3",
        measurementId: "G-6EHMMR974J"
      };

      // Initialize Firebase
      let db;
      
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        console.log('‚úÖ Firebase initialized successfully');
      } catch (error) {
        console.error('‚ùå Firebase initialization error:', error);
      }
      
      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const bookingType = urlParams.get('type');
      const amount = urlParams.get('amount');
      const talentId = urlParams.get('talent_id');
      const talentName = urlParams.get('talent_name');
      const eventName = urlParams.get('event_name');
      const eventDate = urlParams.get('event_date');
      const eventLocation = urlParams.get('event_location');
      const tickets = urlParams.get('tickets');
      
      // Helper functions
      function setFieldValue(id, value) {
        const field = document.getElementById(id);
        if (field && value) field.value = value;
      }
      
      function setTextContent(id, value) {
        const element = document.getElementById(id);
        if (element && value) element.textContent = value;
      }
      
      // Populate fields from URL parameters
      if (bookingType) setFieldValue('bookingType', bookingType);
      if (amount) {
        setFieldValue('bookingAmount', amount);
        setTextContent('mpesaAmount', 'Ksh ' + amount);
        setTextContent('paybillAmount', 'Ksh ' + amount);
        setTextContent('total-amount-display', 'Ksh ' + amount);
        setTextContent('summaryAmount', 'Ksh ' + amount);
      }
      if (talentId) setFieldValue('bookingTalentId', talentId);
      if (talentName) {
        setFieldValue('bookingTalentName', talentName);
        setTextContent('summaryTalentName', talentName);
      }
      if (eventName) setFieldValue('bookingEventName', eventName);
      if (eventDate) setFieldValue('bookingEventDate', eventDate);
      if (eventLocation) setFieldValue('bookingLocation', eventLocation);
      
      // Show booking summary if talent booking
      if (bookingType === 'talent' && talentName) {
        const bookingSummary = document.getElementById('bookingSummary');
        if (bookingSummary) bookingSummary.style.display = 'block';
      }
      
      // Show order summary if event ticket
      if (bookingType === 'event_ticket' && tickets) {
        const orderSummary = document.getElementById('orderSummary');
        if (orderSummary) {
          orderSummary.style.display = 'block';
          
          try {
            const ticketsData = JSON.parse(tickets);
            const orderItems = document.getElementById('order-items');
            orderItems.innerHTML = '';
            
            ticketsData.forEach(ticket => {
              const itemDiv = document.createElement('div');
              itemDiv.className = 'flex justify-between mb-2';
              itemDiv.innerHTML = `
                <span>${ticket.type} x${ticket.quantity}</span>
                <span>Ksh ${ticket.total}</span>
              `;
              orderItems.appendChild(itemDiv);
            });
          } catch (e) {
            console.error('Error parsing tickets:', e);
          }
        }
      }
      
      // Payment method change
      const paymentMethodSelect = document.getElementById('payment_method');
      if (paymentMethodSelect) {
        paymentMethodSelect.addEventListener('change', function() {
          const method = this.value;
          const mpesaDetails = document.getElementById('mpesa-details');
          const paybillDetails = document.getElementById('paybill-details');
          const transactionGroup = document.getElementById('transaction-reference-group');
          
          if (mpesaDetails) mpesaDetails.style.display = 'none';
          if (paybillDetails) paybillDetails.style.display = 'none';
          if (transactionGroup) transactionGroup.style.display = 'none';
          
          if (method === 'mpesa' && mpesaDetails && transactionGroup) {
            mpesaDetails.style.display = 'block';
            transactionGroup.style.display = 'block';
          } else if (method === 'paybill' && paybillDetails && transactionGroup) {
            paybillDetails.style.display = 'block';
            transactionGroup.style.display = 'block';
          }
        });
      }
      
      // Transaction code handling
      const transactionInput = document.getElementById('transaction_reference');
      if (transactionInput) {
        // Auto uppercase
        transactionInput.addEventListener('input', function() {
          const cursorPos = this.selectionStart;
          this.value = this.value.toUpperCase();
          this.setSelectionRange(cursorPos, cursorPos);
        });
        
        // Auto-extract M-Pesa code from pasted message
        transactionInput.addEventListener('paste', function(e) {
          setTimeout(() => {
            const pastedText = this.value;
            // Extract M-Pesa transaction code - looks for alphanumeric sequence 6-12 chars
            const codePatterns = [
              /([A-Z0-9]{10})/i,  // 10 char codes (most common)
              /([A-Z0-9]{8,12})/i, // 8-12 chars
              /([A-Z]{2}\d{8}[A-Z]{2})/i, // Pattern like SH12345678AB
              /([A-Z0-9]{6,12})/i  // Fallback 6-12 chars
            ];
            
            for (const pattern of codePatterns) {
              const match = pastedText.match(pattern);
              if (match && match[1]) {
                this.value = match[1].toUpperCase();
                Swal.fire({
                  icon: 'success',
                  title: 'Code Extracted!',
                  text: 'Transaction code: ' + match[1],
                  timer: 2000,
                  showConfirmButton: false,
                  toast: true,
                  position: 'top-end'
                });
                break;
              }
            }
          }, 10);
        });
      }
      
      // Copy to clipboard function
      window.copyToClipboard = function(text, button) {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(text).then(() => {
            const original = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Copied';
            button.style.background = '#218838';
            
            setTimeout(() => {
              button.innerHTML = original;
              button.style.background = '';
            }, 2000);
          }).catch(err => {
            fallbackCopy(text, button);
          });
        } else {
          fallbackCopy(text, button);
        }
      };
      
      function fallbackCopy(text, button) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const original = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied';
        button.style.background = '#218838';
        
        setTimeout(() => {
          button.innerHTML = original;
          button.style.background = '';
        }, 2000);
      }
      
      // FORM SUBMISSION WITH FIXED VALIDATION
      const paymentForm = document.getElementById('payment-form');
      if (paymentForm) {
        paymentForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const paymentMethod = document.getElementById('payment_method').value;
          let transactionRef = document.getElementById('transaction_reference').value.trim().toUpperCase();
          
          // Clean the transaction code - remove spaces, dashes, dots
          transactionRef = transactionRef.replace(/[\s\-\.]/g, '');
          
          // Validate payment method
          if (!paymentMethod) {
            Swal.fire({
              icon: 'error',
              title: 'Select Payment Method',
              text: 'Please choose M-Pesa or Paybill',
              confirmButtonColor: '#BA0909'
            });
            return;
          }
          
          // Validate transaction code exists
          if (!transactionRef) {
            document.getElementById('transaction_reference').focus();
            Swal.fire({
              icon: 'error',
              title: 'Transaction Code Required',
              text: 'Please enter the M-Pesa transaction code from your SMS',
              confirmButtonColor: '#BA0909'
            });
            return;
          }
          
          // FIXED VALIDATION - Accept 6-12 character codes
          if (transactionRef.length < 6) {
            Swal.fire({
              icon: 'warning',
              title: 'Code Too Short',
              html: `
                <p>M-Pesa transaction codes must be at least 6 characters.</p>
                <p class="text-sm text-gray-600 mt-2">Your code: <strong>${transactionRef}</strong> (${transactionRef.length} characters)</p>
              `,
              confirmButtonColor: '#BA0909'
            });
            return;
          }
          
          if (transactionRef.length > 12) {
            Swal.fire({
              icon: 'warning',
              title: 'Code Too Long',
              html: `
                <p>M-Pesa codes are maximum 12 characters.</p>
                <p class="text-sm text-gray-600 mt-2">Your code: <strong>${transactionRef}</strong> (${transactionRef.length} characters)</p>
                <p class="text-sm text-gray-600 mt-2">Please check the SMS and enter only the transaction code.</p>
              `,
              confirmButtonColor: '#BA0909'
            });
            return;
          }
          
          // Check if code contains only letters and numbers
          if (!/^[A-Z0-9]+$/.test(transactionRef)) {
            Swal.fire({
              icon: 'warning',
              title: 'Invalid Characters',
              html: `
                <p>M-Pesa codes contain only letters (A-Z) and numbers (0-9).</p>
                <p class="text-sm text-gray-600 mt-2">Your code: <code class="bg-gray-100 px-2 py-1 rounded">${transactionRef}</code></p>
                <p class="text-sm text-red-600 mt-2">Remove any spaces, dashes (-), dots (.) or special characters.</p>
              `,
              confirmButtonColor: '#BA0909'
            });
            return;
          }
          
          // Show loading
          Swal.fire({
            title: 'Processing Payment...',
            html: `
              <div class="text-center py-4">
                <div class="mb-4">
                  <i class="fas fa-spinner fa-spin text-5xl text-primary"></i>
                </div>
                <p class="text-lg mb-2">Verifying transaction code</p>
                <p class="font-mono text-xl font-bold text-green-600">${transactionRef}</p>
                <p class="text-sm text-gray-600 mt-3">Please wait while we save your payment...</p>
              </div>
            `,
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          
          try {
            // Check if Firebase is available
            if (!db) {
              throw new Error('Database connection unavailable. Please check your internet connection and try again.');
            }
            
            // Check for duplicate transaction code
            console.log('üîç Checking for duplicate transaction:', transactionRef);
            const duplicateCheck = await db.collection('payments')
              .where('transactionReference', '==', transactionRef)
              .where('status', 'in', ['pending', 'confirmed'])
              .get();
            
            if (!duplicateCheck.empty) {
              const existingPayment = duplicateCheck.docs[0];
              const existingData = existingPayment.data();
              
              Swal.fire({
                icon: 'error',
                title: 'Duplicate Transaction Code',
                html: `
                  <div class="text-left">
                    <p class="mb-3">This M-Pesa code has already been used for a payment.</p>
                    <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                      <p class="text-sm"><strong>Transaction Code:</strong> ${transactionRef}</p>
                      <p class="text-sm mt-1"><strong>Previous Payment ID:</strong> ${existingPayment.id.slice(0, 8).toUpperCase()}</p>
                      <p class="text-sm mt-1"><strong>Amount:</strong> KSH ${existingData.amount || 'N/A'}</p>
                      <p class="text-sm mt-1"><strong>Status:</strong> ${existingData.status || 'Unknown'}</p>
                    </div>
                    <p class="mt-3 text-sm text-gray-700">Each M-Pesa transaction code can only be used once.</p>
                    <p class="text-sm text-gray-700 mt-2">If this is a new payment, please check your M-Pesa SMS for the correct transaction code.</p>
                  </div>
                `,
                confirmButtonColor: '#BA0909',
                confirmButtonText: 'Enter Correct Code',
                showCancelButton: true,
                cancelButtonText: 'Contact Support'
              }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                  window.open('https://wa.me/+254797265275?text=Duplicate%20Payment%20Issue:%20' + encodeURIComponent(transactionRef), '_blank');
                }
              });
              return;
            }
            
            // Prepare payment data
            // In the payment form submission section, update the paymentData object:
const paymentData = {
    fullName: document.getElementById('full_name').value.trim(),
    email: document.getElementById('email').value.trim().toLowerCase(),
    phoneNumber: document.getElementById('phone_number').value.trim(),
    paymentMethod: paymentMethod,
    transactionReference: transactionRef,
    amount: parseFloat(document.getElementById('bookingAmount').value) || 0,
    bookingType: document.getElementById('bookingType').value || 'general',
    talentId: document.getElementById('bookingTalentId').value || null,
    talentName: document.getElementById('bookingTalentName').value || null,
    eventName: document.getElementById('bookingEventName').value || null,
    eventDate: document.getElementById('bookingEventDate').value || null,
    eventLocation: document.getElementById('bookingLocation').value || null,
    
    // NEW: Ticket details
    ticketType: 'Event Ticket',
    numberOfTickets: 1,
    ticketPrice: parseFloat(document.getElementById('bookingAmount').value) || 0,
    
    // Handle multiple tickets from event booking
    ticketDetails: [],
    
    status: 'pending',
    paymentDate: new Date().toISOString(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    userAgent: navigator.userAgent,
    source: 'website',
    formattedDate: new Date().toLocaleString('en-KE', {timeZone: 'Africa/Nairobi'})
};

// If there are multiple tickets (from event booking)
if (bookingType === 'event_ticket' && tickets) {
    try {
        const ticketsData = JSON.parse(decodeURIComponent(tickets));
        console.log('Parsed ticket data:', ticketsData);
        
        // Calculate total tickets and amount
        let totalTickets = 0;
        let totalAmount = 0;
        const ticketDetails = [];
        
        ticketsData.forEach(ticket => {
            const quantity = parseInt(ticket.quantity) || 1;
            const price = parseFloat(ticket.price) || 0;
            totalTickets += quantity;
            totalAmount += price * quantity;
            
            ticketDetails.push({
                type: ticket.type,
                quantity: quantity,
                price: price,
                total: price * quantity
            });
        });
        
        paymentData.numberOfTickets = totalTickets;
        paymentData.amount = totalAmount;
        paymentData.ticketDetails = ticketDetails;
        
        // Update amount display
        document.getElementById('bookingAmount').value = totalAmount;
        document.getElementById('mpesaAmount').textContent = 'Ksh ' + totalAmount;
        document.getElementById('paybillAmount').textContent = 'Ksh ' + totalAmount;
        
    } catch (e) {
        console.error('Error parsing tickets:', e);
    }
}
            console.log('üíæ Saving payment data:', paymentData);
            
            // Save to Firestore
            const docRef = await db.collection('payments').add(paymentData);
            
            console.log('‚úÖ Payment saved successfully! ID:', docRef.id);
            
            // Success message
            Swal.fire({
              icon: 'success',
              title: '‚úÖ Payment Submitted Successfully!',
              html: `
                <div class="text-center">
                  <div class="mb-4 p-5 bg-green-50 rounded-xl border-2 border-green-200">
                    <div class="mb-3">
                      <i class="fas fa-check-circle text-green-600" style="font-size: 60px;"></i>
                    </div>
                    <p class="text-lg font-bold mb-3">Payment Reference Number</p>
                    <p class="text-3xl font-mono font-bold text-green-600 mb-3">${docRef.id.slice(0, 8).toUpperCase()}</p>
                    <div class="pt-3 border-t-2 border-green-200">
                      <p class="text-sm text-gray-700"><strong>M-Pesa Code:</strong> ${transactionRef}</p>
                      <p class="text-sm text-gray-700 mt-1"><strong>Amount:</strong> KSH ${paymentData.amount.toLocaleString()}</p>
                      <p class="text-sm text-gray-700 mt-1"><strong>Method:</strong> ${paymentMethod === 'mpesa' ? 'M-Pesa Till' : 'Paybill'}</p>
                    </div>
                  </div>
                  
                  <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <p class="text-sm font-bold mb-2"><i class="fas fa-info-circle text-blue-600"></i> What Happens Next?</p>
                    <ul class="text-sm text-left space-y-2 mt-2">
                      <li>‚úÖ Your payment has been recorded</li>
                      <li>‚è≥ We will verify your transaction within 24 hours</li>
                      <li>üìß Confirmation email will be sent to <strong>${paymentData.email}</strong></li>
                      <li>üì± Keep your phone handy - we may call to confirm details</li>
                    </ul>
                  </div>
                  
                  <p class="text-xs text-gray-600 mt-3">
                    <i class="fas fa-bookmark text-primary"></i> 
                    Save this reference number: <strong>${docRef.id.slice(0, 8).toUpperCase()}</strong>
                  </p>
                  
                  <p class="text-xs text-gray-500 mt-2">
                    Check your email for payment receipt and further instructions.
                  </p>
                </div>
              `,
              confirmButtonColor: '#BA0909',
              confirmButtonText: 'üè† Back to Home',
              allowOutsideClick: false,
              allowEscapeKey: false
            }).then((result) => {
              if (result.isConfirmed) {
                window.location.href = 'index.html';
              }
            });
            
          } catch (error) {
            console.error('‚ùå Error saving payment:', error);
            console.error('Error details:', {
              code: error.code,
              message: error.message,
              stack: error.stack
            });
            
            // Determine error type
            let errorTitle = 'Payment Submission Failed';
            let errorMessage = error.message;
            let errorHint = '';
            
            if (error.code === 'permission-denied') {
              errorTitle = 'Permission Error';
              errorMessage = 'Unable to save payment due to database permissions.';
              errorHint = 'This is likely a temporary issue. Please try again in a few moments.';
            } else if (error.code === 'unavailable') {
              errorTitle = 'Connection Error';
              errorMessage = 'Unable to connect to the database.';
              errorHint = 'Please check your internet connection and try again.';
            } else if (error.code === 'unauthenticated') {
              errorTitle = 'Authentication Error';
              errorMessage = 'Session expired or authentication failed.';
              errorHint = 'Please refresh the page and try again.';
            }
            
            Swal.fire({
              icon: 'error',
              title: errorTitle,
              html: `
                <div class="text-left">
                  <p class="mb-3">${errorMessage}</p>
                  ${errorHint ? `<p class="text-sm text-gray-700 mb-3">${errorHint}</p>` : ''}
                  
                  <div class="p-4 bg-red-50 rounded-lg border border-red-200 mb-3">
                    <p class="text-sm font-bold mb-2">Error Details:</p>
                    <p class="text-xs text-gray-600">Code: ${error.code || 'Unknown'}</p>
                    <p class="text-xs text-gray-600 mt-1">Message: ${error.message}</p>
                  </div>
                  
                  <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200 mb-3">
                    <p class="text-sm font-bold mb-2"><i class="fas fa-exclamation-triangle text-yellow-600"></i> Your Payment Information:</p>
                    <p class="text-sm mt-1"><strong>M-Pesa Code:</strong> ${transactionRef}</p>
                    <p class="text-sm mt-1"><strong>Amount:</strong> KSH ${document.getElementById('bookingAmount').value}</p>
                    <p class="text-sm mt-1"><strong>Name:</strong> ${document.getElementById('full_name').value}</p>
                    <p class="text-xs text-gray-600 mt-2">üì∏ Please screenshot this information!</p>
                  </div>
                  
                  <div class="p-3 bg-gray-100 rounded">
                    <p class="text-sm font-bold mb-1">Contact Support:</p>
                    <p class="text-xs">üìû WhatsApp: +254797265275</p>
                    <p class="text-xs">üìß Email: info@kalenjinvibes.com</p>
                  </div>
                </div>
              `,
              confirmButtonColor: '#BA0909',
              confirmButtonText: 'Try Again',
              showCancelButton: true,
              cancelButtonText: 'Contact Support',
              cancelButtonColor: '#25D366'
            }).then((result) => {
              if (result.dismiss === Swal.DismissReason.cancel) {
                const message = `Payment Error%0A%0ATransaction Code: ${transactionRef}%0AAmount: KSH ${document.getElementById('bookingAmount').value}%0AError: ${error.message}`;
                window.open('https://wa.me/+254797265275?text=' + message, '_blank');
              }
            });
          }
        });
      }
      
      // Auto-focus first input on page load
      setTimeout(function() {
        document.getElementById('full_name')?.focus();
        
        if (amount) {
          console.log('üí∞ Payment amount loaded from URL:', amount);
        }
      }, 100);
    });
  </script>

</body>
</html>
        