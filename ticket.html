<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kalenjin Vibes ‚Äì Retrieve Tickets</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- QR + PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700&display=swap');

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #0a0015 0%, #1a0033 25%, #2d0052 50%, #1a0033 75%, #0a0015 100%);
  background-size: 400% 400%;
  animation: gradientShift 15s ease infinite;
  min-height: 100vh;
  overflow-x: hidden;
}

@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.neon-text {
  font-family: 'Orbitron', sans-serif;
  text-shadow: 
    0 0 10px #00ffff,
    0 0 20px #00ffff,
    0 0 30px #00ffff,
    0 0 40px #ff00ff,
    0 0 70px #ff00ff,
    0 0 80px #ff00ff,
    0 0 100px #ff00ff;
  animation: flicker 3s ease-in-out infinite;
}

@keyframes flicker {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.neon-border {
  border: 2px solid #00ffff;
  box-shadow: 
    0 0 10px #00ffff,
    inset 0 0 10px #00ffff,
    0 0 20px #ff00ff,
    inset 0 0 20px #ff00ff;
  animation: borderPulse 2s ease-in-out infinite;
}

@keyframes borderPulse {
  0%, 100% { 
    box-shadow: 
      0 0 10px #00ffff,
      inset 0 0 10px #00ffff,
      0 0 20px #ff00ff,
      inset 0 0 20px #ff00ff;
  }
  50% { 
    box-shadow: 
      0 0 20px #00ffff,
      inset 0 0 20px #00ffff,
      0 0 40px #ff00ff,
      inset 0 0 40px #ff00ff;
  }
}

.glass-morphism {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.ticket-glow {
  box-shadow: 
    0 0 30px rgba(0, 255, 255, 0.3),
    0 0 60px rgba(255, 0, 255, 0.3),
    inset 0 0 30px rgba(0, 255, 255, 0.1);
}

.floating {
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

.glow-button {
  background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%);
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
  transition: all 0.3s ease;
}

.glow-button:hover {
  box-shadow: 0 0 40px rgba(0, 255, 255, 0.8), 0 0 60px rgba(255, 0, 255, 0.6);
  transform: scale(1.05);
}

.spinner {
  border: 4px solid rgba(255, 255, 255, 0.1);
  border-top: 4px solid #00ffff;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.qr-container {
  background: white;
  border-radius: 12px;
  padding: 10px;
  display: inline-block;
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
}

.status-active {
  background: linear-gradient(135deg, #00ff88 0%, #00ffff 100%);
  color: #000;
  text-shadow: none;
}

.status-used {
  background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
}

.status-pending {
  background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
  color: #000;
  text-shadow: none;
}

.particles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 0;
}

.particle {
  position: absolute;
  width: 4px;
  height: 4px;
  background: #00ffff;
  border-radius: 50%;
  animation: particleFloat 10s linear infinite;
}

@keyframes particleFloat {
  0% {
    transform: translateY(100vh) translateX(0);
    opacity: 0;
  }
  10% {
    opacity: 1;
  }
  90% {
    opacity: 1;
  }
  100% {
    transform: translateY(-100vh) translateX(100px);
    opacity: 0;
  }
}
</style>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        neon: {
          cyan: '#00ffff',
          pink: '#ff00ff',
          purple: '#8b00ff',
          blue: '#0099ff',
        }
      }
    }
  }
}
</script>
</head>

<body class="relative">

<!-- Animated Particles Background -->
<div class="particles">
  <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
  <div class="particle" style="left: 20%; animation-delay: 2s;"></div>
  <div class="particle" style="left: 30%; animation-delay: 4s;"></div>
  <div class="particle" style="left: 40%; animation-delay: 1s;"></div>
  <div class="particle" style="left: 50%; animation-delay: 3s;"></div>
  <div class="particle" style="left: 60%; animation-delay: 5s;"></div>
  <div class="particle" style="left: 70%; animation-delay: 2.5s;"></div>
  <div class="particle" style="left: 80%; animation-delay: 4.5s;"></div>
  <div class="particle" style="left: 90%; animation-delay: 1.5s;"></div>
</div>

<div class="relative z-10 min-h-screen py-12 px-4">
  <div class="max-w-6xl mx-auto">
    
    <!-- Header -->
    <div class="text-center mb-16 floating">
      <h1 class="text-7xl font-black neon-text mb-4 tracking-wider">
        üéµ KALENJIN VIBES
      </h1>
      <div class="inline-block px-8 py-3 glass-morphism neon-border rounded-full">
        <p class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-pink-400 bg-clip-text text-transparent">
          Ticket Retrieval System
        </p>
      </div>
    </div>

    <!-- Search Form -->
    <div class="max-w-2xl mx-auto mb-12">
      <div class="glass-morphism neon-border rounded-3xl p-8 ticket-glow">
        <h3 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-cyan-300 to-pink-300 bg-clip-text text-transparent">
          Retrieve Your Tickets
        </h3>
        
        <div class="space-y-4">
          <div>
            <label class="block text-cyan-300 mb-2 font-semibold">üìß Email Address</label>
            <input 
              id="userEmail" 
              type="email"
              class="w-full px-6 py-4 rounded-xl bg-black/50 text-white border-2 border-cyan-500/30 focus:border-cyan-500 focus:outline-none transition-all"
              placeholder="your.email@example.com"
            />
          </div>
          
          <div>
            <label class="block text-pink-300 mb-2 font-semibold">üî¢ Transaction Code</label>
            <input 
              id="transactionCode" 
              type="text"
              class="w-full px-6 py-4 rounded-xl bg-black/50 text-white border-2 border-pink-500/30 focus:border-pink-500 focus:outline-none transition-all uppercase"
              placeholder="SK7AP2Z0YL"
            />
          </div>
          
          <button 
            onclick="findTickets()" 
            class="w-full py-5 rounded-xl glow-button text-black font-bold text-xl tracking-wide"
          >
            üîç FIND MY TICKETS
          </button>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="hidden">
      <div class="text-center mb-8">
        <h2 id="summary" class="text-4xl font-bold bg-gradient-to-r from-green-400 to-cyan-400 bg-clip-text text-transparent"></h2>
      </div>
      
      <div id="ticketsContainer" class="space-y-8"></div>

      <!-- Download Section -->
      <div class="mt-12 text-center">
        <div class="glass-morphism neon-border rounded-3xl p-8 inline-block ticket-glow">
          <h3 class="text-2xl font-bold text-cyan-300 mb-4">üì• Download All Tickets</h3>
          <button 
            onclick="downloadAllTickets()" 
            class="px-12 py-5 rounded-xl glow-button text-black font-bold text-xl"
          >
            üìÑ DOWNLOAD PDF
          </button>
          <p class="text-gray-400 mt-4 text-sm">
            üíæ Save to your phone for easy venue access
          </p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Firebase & Logic -->
<script>
const firebaseConfig = {
  apiKey: "AIzaSyARficcDI3R1ELfjkQxL-kkFQr-tzOgzgo",
  authDomain: "k-vibez.firebaseapp.com",
  projectId: "k-vibez",
  storageBucket: "k-vibez.firebasestorage.app",
  messagingSenderId: "1060235903242",
  appId: "1:1060235903242:web:4649b48406879fb7fcfaf3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

window.findTickets = async function () {
  const email = userEmail.value.trim().toLowerCase();
  const tx = transactionCode.value.trim().toUpperCase();

  if (!email || !tx) {
    alert("‚ö†Ô∏è Please enter both email and transaction code");
    return;
  }

  ticketsContainer.innerHTML = `
    <div class="flex justify-center items-center py-20">
      <div class="text-center">
        <div class="spinner mx-auto mb-6"></div>
        <p class="text-2xl text-cyan-300 animate-pulse">üîç Searching for your tickets...</p>
      </div>
    </div>
  `;
  resultsSection.classList.remove('hidden');

  try {
    const querySnapshot = await db.collection("tickets")
      .where("customerEmail", "==", email)
      .where("transactionReference", "==", tx)
      .get();

    if (querySnapshot.empty) {
      ticketsContainer.innerHTML = `
        <div class="glass-morphism rounded-3xl p-12 text-center neon-border">
          <div class="text-6xl mb-4">‚ùå</div>
          <h3 class="text-3xl font-bold text-red-400 mb-4">No Tickets Found</h3>
          <p class="text-gray-300 mb-2">Please check your email and transaction code</p>
          <p class="text-sm text-gray-500">Use the exact details from your payment confirmation</p>
        </div>
      `;
      return;
    }

    const tickets = [];
    querySnapshot.forEach((doc) => {
      tickets.push({ id: doc.id, ...doc.data() });
    });

    tickets.sort((a, b) => (a.ticketIndex || 0) - (b.ticketIndex || 0));

    summary.textContent = `‚úÖ ${tickets.length} ticket(s) found for ${tx}`;
    renderTickets(tickets);

  } catch (error) {
    console.error("Error:", error);
    ticketsContainer.innerHTML = `
      <div class="glass-morphism rounded-3xl p-12 text-center border-2 border-red-500">
        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
        <h3 class="text-3xl font-bold text-red-400 mb-4">Error Loading Tickets</h3>
        <p class="text-gray-300">${error.message}</p>
      </div>
    `;
  }
};

function renderTickets(tickets) {
  ticketsContainer.innerHTML = "";

  tickets.forEach((ticket, index) => {
    const created = ticket.createdAt?.toDate 
      ? ticket.createdAt.toDate().toLocaleString() 
      : "N/A";

    const statusClass = ticket.status === 'active' ? 'status-active' : 
                       ticket.status === 'used' ? 'status-used' : 'status-pending';

    const card = document.createElement("div");
    card.className = "ticket-individual";

    card.innerHTML = `
      <div class="glass-morphism neon-border rounded-2xl p-4 ticket-glow hover:scale-105 transition-transform">
        <!-- Ticket Number Badge -->
        <div class="flex justify-between items-start mb-3">
          <div class="inline-block px-3 py-1 rounded-full bg-gradient-to-r from-purple-600 to-pink-600">
            <span class="text-white font-bold text-xs">Ticket ${ticket.ticketIndex || index + 1}/${tickets.length}</span>
          </div>
          <span class="px-3 py-1 rounded-full ${statusClass} font-bold text-xs uppercase">
            ${ticket.status || 'active'}
          </span>
        </div>

        <!-- Festival Header -->
        <div class="text-center mb-4 pb-3 border-b border-dashed border-cyan-500/30">
          <h2 class="text-xl font-black neon-text mb-1">üéµ KALENJIN VIBES</h2>
          <p class="text-cyan-300 text-xs uppercase tracking-wide">Official Entry Ticket</p>
        </div>

        <!-- Ticket Info Grid -->
        <div class="grid grid-cols-2 gap-3 mb-4">
          <div>
            <p class="text-cyan-400 text-xs font-semibold mb-0.5">üë§ NAME</p>
            <p class="text-white font-bold text-sm">${ticket.customerName || 'Guest'}</p>
          </div>
          <div>
            <p class="text-pink-400 text-xs font-semibold mb-0.5">üé´ TYPE</p>
            <p class="text-white font-bold text-sm">${ticket.ticketType || 'General'}</p>
          </div>
          <div>
            <p class="text-purple-400 text-xs font-semibold mb-0.5">üìß EMAIL</p>
            <p class="text-white text-xs break-all">${ticket.customerEmail || 'N/A'}</p>
          </div>
          <div>
            <p class="text-green-400 text-xs font-semibold mb-0.5">üî¢ TRANSACTION</p>
            <p class="text-white text-xs">${ticket.transactionReference || 'N/A'}</p>
          </div>
          <div class="col-span-2">
            <p class="text-yellow-400 text-xs font-semibold mb-0.5">üìÖ ISSUED</p>
            <p class="text-white text-xs">${created}</p>
          </div>
        </div>

        <!-- QR Code Section -->
        <div id="qr-${index}" class="text-center bg-gradient-to-br from-purple-900/30 to-pink-900/30 rounded-xl p-3"></div>
      </div>
    `;

    ticketsContainer.appendChild(card);

    const qrDiv = document.getElementById(`qr-${index}`);

    if (ticket.verified === true && ticket.status === "active") {
      const container = document.createElement("div");
      container.className = "inline-block";
      
      const qrBox = document.createElement("div");
      qrBox.className = "qr-container";
      container.appendChild(qrBox);

      new QRCode(qrBox, {
        text: ticket.id,
        width: 150,
        height: 150,
        correctLevel: QRCode.CorrectLevel.H
      });

      qrDiv.appendChild(container);

      const instruction = document.createElement("p");
      instruction.className = "text-cyan-300 text-xs mt-2 font-semibold animate-pulse";
      instruction.textContent = "üì± Show at venue entrance";
      qrDiv.appendChild(instruction);

    } else if (ticket.status === "used") {
      qrDiv.innerHTML = `
        <div class="py-4">
          <div class="text-3xl mb-2">‚úÖ</div>
          <p class="text-sm font-bold text-green-400">Already Used</p>
        </div>
      `;
    } else if (!ticket.verified) {
      qrDiv.innerHTML = `
        <div class="py-4">
          <div class="text-3xl mb-2">‚è≥</div>
          <p class="text-sm font-bold text-yellow-400">Pending</p>
        </div>
      `;
    } else {
      qrDiv.innerHTML = `
        <div class="py-4">
          <div class="text-3xl mb-2">‚ùå</div>
          <p class="text-sm font-bold text-red-400">Unavailable</p>
        </div>
      `;
    }
  });
}

window.downloadAllTickets = async function () {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');

  const cards = document.querySelectorAll(".ticket-individual");

  if (cards.length === 0) {
    alert("No tickets to download");
    return;
  }

  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '‚è≥ GENERATING PDF...';
  btn.disabled = true;

  try {
    for (let i = 0; i < cards.length; i++) {
      if (i > 0) pdf.addPage();

      // ‚úÖ WAIT FOR QR CODE TO FULLY RENDER
      await new Promise(resolve => setTimeout(resolve, 500));

      const canvas = await html2canvas(cards[i], {
        scale: 2.5, // ‚úÖ OPTIMIZED FOR SMALLER SIZE BUT GOOD QUALITY
        backgroundColor: "#1a0033",
        logging: false,
        useCORS: true,
        allowTaint: true,
        foreignObjectRendering: false
      });

      const imgData = canvas.toDataURL("image/png");
      const imgWidth = 160; // ‚úÖ REDUCED FROM 180mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      const x = (210 - imgWidth) / 2;
      const y = 15; // ‚úÖ REDUCED TOP MARGIN

      pdf.addImage(imgData, "PNG", x, y, imgWidth, imgHeight);
    }

    const timestamp = new Date().toISOString().split('T')[0];
    pdf.save(`Kalenjin_Vibes_Tickets_${timestamp}.pdf`);

    btn.innerHTML = originalText;
    btn.disabled = false;

  } catch (error) {
    console.error("PDF error:", error);
    alert("Failed to generate PDF. Please try again.");
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
};

console.log("‚úÖ Neon Ticket Retrieval System Loaded");
</script>

</body>
</html>