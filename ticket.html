<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kalenjin Vibes ‚Äì Retrieve Tickets</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- UI -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- QR + PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- üî• FIREBASE v8 (SAME AS ADMIN) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
body {
  background: linear-gradient(135deg,#0f0c29,#302b63,#24243e);
  color:white;
  min-height:100vh;
  font-family: 'Segoe UI', system-ui, sans-serif;
}
.container {
  max-width: 900px;
}
.ticket-card {
  background: linear-gradient(135deg,#667eea,#764ba2);
  border-radius: 20px;
  padding: 30px;
  margin-bottom: 25px;
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
  position: relative;
}
.ticket-header {
  text-align: center;
  margin-bottom: 20px;
  border-bottom: 2px dashed rgba(255,255,255,0.3);
  padding-bottom: 15px;
}
.ticket-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 20px;
}
.ticket-info p {
  margin: 5px 0;
  font-size: 14px;
}
.ticket-info b {
  color: rgba(255,255,255,0.8);
  display: block;
  margin-bottom: 3px;
}
.qr-section {
  text-align: center;
  background: rgba(255,255,255,0.1);
  padding: 20px;
  border-radius: 15px;
  margin-top: 20px;
}
.qr-box {
  background: white;
  padding: 15px;
  border-radius: 15px;
  display: inline-block;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.badge-active { 
  background: #28a745; 
  color: white;
  padding: 5px 15px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}
.badge-used { 
  background: #6c757d;
  color: white;
  padding: 5px 15px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}
.badge-expired { 
  background: #dc3545;
  color: white;
  padding: 5px 15px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}
.badge-rejected { 
  background: #000;
  color: white;
  padding: 5px 15px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}
.loading-spinner {
  text-align: center;
  padding: 40px;
}
.spinner-border {
  width: 3rem;
  height: 3rem;
}
.input-group {
  background: rgba(255,255,255,0.1);
  border-radius: 15px;
  padding: 30px;
  margin-bottom: 30px;
  backdrop-filter: blur(10px);
}
.festival-logo {
  text-align: center;
  margin-bottom: 30px;
}
.festival-logo h1 {
  font-size: 2.5rem;
  font-weight: bold;
  background: linear-gradient(135deg, #667eea, #764ba2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.download-section {
  text-align: center;
  margin-top: 40px;
  padding: 20px;
  background: rgba(255,255,255,0.1);
  border-radius: 15px;
  backdrop-filter: blur(10px);
}
.ticket-number {
  position: absolute;
  top: 15px;
  right: 20px;
  background: rgba(0,0,0,0.3);
  padding: 8px 15px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 14px;
}
.qr-instruction {
  color: rgba(255,255,255,0.9);
  font-size: 13px;
  margin-top: 10px;
  font-style: italic;
}
</style>
</head>

<body class="py-5">

<div class="container">
  <div class="festival-logo">
    <h1>üéµ KALENJIN VIBES FESTIVAL</h1>
    <p class="text-center" style="color: rgba(255,255,255,0.8);">Ticket Retrieval System</p>
  </div>

  <div class="input-group">
    <h5 class="text-center mb-4">Enter Your Details</h5>
    <div class="row justify-content-center">
      <div class="col-md-10">
        <input id="userEmail" class="form-control mb-3" placeholder="üìß Email address (as provided during purchase)">
        <input id="transactionCode" class="form-control mb-3" placeholder="üî¢ Transaction code (e.g., SK7AP2Z0YL)">
        <button class="btn btn-primary btn-lg w-100" onclick="findTickets()">
          üîç Find My Tickets
        </button>
      </div>
    </div>
  </div>

  <div id="resultsSection" style="display:none;">
    <h4 class="text-center mb-4" id="summary"></h4>
    <div id="ticketsContainer"></div>

    <div class="download-section">
      <h5 class="mb-3">üì• Download Options</h5>
      <button class="btn btn-success btn-lg" onclick="downloadAllTickets()">
        üìÑ Download ALL Tickets (PDF)
      </button>
      <p class="text-muted mt-3" style="font-size: 14px;">
        Save this PDF to your phone for easy access at the venue
      </p>
    </div>
  </div>
</div>

<!-- ================= FIREBASE v8 + LOGIC ================= -->
<script>
/* ================= FIREBASE CONFIG (v8 - Same as Admin) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyARficcDI3R1ELfjkQxL-kkFQr-tzOgzgo",
  authDomain: "k-vibez.firebaseapp.com",
  projectId: "k-vibez",
  storageBucket: "k-vibez.firebasestorage.app",
  messagingSenderId: "1060235903242",
  appId: "1:1060235903242:web:4649b48406879fb7fcfaf3"
};

// Initialize Firebase v8
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= FIND TICKETS (Firebase v8 syntax) ================= */
window.findTickets = async function () {
  const email = userEmail.value.trim().toLowerCase();
  const tx = transactionCode.value.trim().toUpperCase();

  if (!email || !tx) {
    alert("‚ö†Ô∏è Please enter both email and transaction code");
    return;
  }

  ticketsContainer.innerHTML = `
    <div class="loading-spinner">
      <div class="spinner-border text-light" role="status"></div>
      <p class="mt-3">üîç Searching for your tickets...</p>
    </div>
  `;
  resultsSection.style.display = "block";

  try {
    // Firebase v8 query syntax
    const querySnapshot = await db.collection("tickets")
      .where("customerEmail", "==", email)
      .where("transactionReference", "==", tx)
      .get();

    if (querySnapshot.empty) {
      ticketsContainer.innerHTML = `
        <div class="alert alert-warning text-center">
          <h5>‚ùå No tickets found</h5>
          <p>Please check your email and transaction code</p>
          <small>Make sure to use the exact email and transaction code from your payment confirmation</small>
        </div>
      `;
      return;
    }

    const tickets = [];
    querySnapshot.forEach((doc) => {
      tickets.push({ id: doc.id, ...doc.data() });
    });

    // Sort by ticket index
    tickets.sort((a, b) => (a.ticketIndex || 0) - (b.ticketIndex || 0));

    summary.textContent = `‚úÖ ${tickets.length} ticket(s) found for transaction ${tx}`;
    renderTickets(tickets);

  } catch (error) {
    console.error("Error fetching tickets:", error);
    ticketsContainer.innerHTML = `
      <div class="alert alert-danger text-center">
        <h5>‚ö†Ô∏è Error loading tickets</h5>
        <p>${error.message}</p>
      </div>
    `;
  }
};

/* ================= RENDER TICKETS ================= */
function renderTickets(tickets) {
  ticketsContainer.innerHTML = "";

  tickets.forEach((ticket, index) => {
    const created = ticket.createdAt?.toDate 
      ? ticket.createdAt.toDate().toLocaleString() 
      : "N/A";

    const card = document.createElement("div");
    card.className = "ticket-card ticket-individual";

    card.innerHTML = `
      <div class="ticket-number">Ticket ${ticket.ticketIndex || index + 1}/${tickets.length}</div>
      
      <div class="ticket-header">
        <h4 style="margin: 0; color: white;">üéµ KALENJIN VIBES FESTIVAL</h4>
        <p style="margin: 5px 0; font-size: 14px; color: rgba(255,255,255,0.8);">Official Entry Ticket</p>
      </div>

      <div class="ticket-info">
        <div>
          <b>üë§ Name</b>
          <span>${ticket.customerName || 'Guest'}</span>
        </div>
        <div>
          <b>üé´ Ticket Type</b>
          <span>${ticket.ticketType || 'General'}</span>
        </div>
        <div>
          <b>üìß Email</b>
          <span style="font-size: 12px;">${ticket.customerEmail || 'N/A'}</span>
        </div>
        <div>
          <b>üî¢ Transaction</b>
          <span style="font-size: 12px;">${ticket.transactionReference || 'N/A'}</span>
        </div>
        <div>
          <b>üìÖ Issued</b>
          <span>${created}</span>
        </div>
        <div>
          <b>üìä Status</b>
          <span class="badge-${ticket.status || 'active'}">${(ticket.status || 'active').toUpperCase()}</span>
        </div>
      </div>

      <div id="qr-${index}" class="qr-section"></div>
    `;

    ticketsContainer.appendChild(card);

    const qrDiv = document.getElementById(`qr-${index}`);

    // Generate QR if ticket is verified and active
    if (ticket.verified === true && ticket.status === "active") {
      const box = document.createElement("div");
      box.className = "qr-box";
      qrDiv.appendChild(box);

      // ‚úÖ CRITICAL: Generate QR with ONLY ticketId (matches admin scanner)
      new QRCode(box, {
        text: ticket.id,  // Just the document ID
        width: 200,
        height: 200,
        correctLevel: QRCode.CorrectLevel.H
      });

      const instruction = document.createElement("p");
      instruction.className = "qr-instruction";
      instruction.textContent = "üì± Show this QR code at the venue entrance";
      qrDiv.appendChild(instruction);

    } else if (ticket.status === "used") {
      qrDiv.innerHTML = `
        <div class="alert alert-info">
          <p class="mb-0">‚úÖ This ticket has been used for entry</p>
        </div>
      `;
    } else if (!ticket.verified) {
      qrDiv.innerHTML = `
        <div class="alert alert-warning">
          <p class="mb-0">‚è≥ Ticket pending verification</p>
          <small>Please contact support if payment was completed</small>
        </div>
      `;
    } else {
      qrDiv.innerHTML = `
        <div class="alert alert-danger">
          <p class="mb-0">‚ùå QR code not available</p>
          <small>Status: ${ticket.status || 'Unknown'}</small>
        </div>
      `;
    }
  });
}

/* ================= DOWNLOAD ALL AS PDF ================= */
window.downloadAllTickets = async function () {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');

  const cards = document.querySelectorAll(".ticket-individual");

  if (cards.length === 0) {
    alert("No tickets to download");
    return;
  }

  // Show loading
  const downloadBtn = event.target;
  const originalText = downloadBtn.innerHTML;
  downloadBtn.innerHTML = '‚è≥ Generating PDF...';
  downloadBtn.disabled = true;

  try {
    for (let i = 0; i < cards.length; i++) {
      if (i > 0) pdf.addPage();

      const canvas = await html2canvas(cards[i], {
        scale: 2,
        backgroundColor: "#667eea",
        logging: false
      });

      const imgData = canvas.toDataURL("image/png");
      const imgWidth = 180;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      // Center on page
      const x = (210 - imgWidth) / 2;
      const y = 20;

      pdf.addImage(imgData, "PNG", x, y, imgWidth, imgHeight);
    }

    const timestamp = new Date().toISOString().split('T')[0];
    pdf.save(`Kalenjin_Vibes_Tickets_${timestamp}.pdf`);

    downloadBtn.innerHTML = originalText;
    downloadBtn.disabled = false;

  } catch (error) {
    console.error("PDF generation error:", error);
    alert("Failed to generate PDF. Please try again.");
    downloadBtn.innerHTML = originalText;
    downloadBtn.disabled = false;
  }
};

console.log("‚úÖ Ticket Retrieval System Loaded (Firebase v8)");
</script>

</body>
</html>